var google,map,DEFAULT_CENTER={lat:47,lng:23},DEFAULT_ZOOM=5;if(void 0==google)$(".mapError").html("<p>Google Maps API cannot be reached. Please try again later.</p>");else{$(".mapError").remove();var mapOptions={zoom:DEFAULT_ZOOM,center:DEFAULT_CENTER,mapTypeControlOptions:{position:google.maps.ControlPosition.TOP_RIGHT}};map=new google.maps.Map(document.getElementById("map"),mapOptions),map.controls[google.maps.ControlPosition.RIGHT_TOP].push(legend)}var Place=function(a){this.name=ko.observable(a.capital+", "+a.name),this.region=ko.observable(a.region)},CoffeeShops=function(a){a.hasOwnProperty("venue")?(this.name=ko.observable(a.venue.name),this.venueId=ko.observable(a.venue.id),this.latitude=ko.observable(a.venue.location.lat),this.longitude=ko.observable(a.venue.location.lng)):(this.name=ko.observable(a.name),this.venueId=ko.observable(a.id),this.latitude=ko.observable(a.location.lat),this.longitude=ko.observable(a.location.lng))},ViewModel=function(){var a=this;a.allPlaceList=ko.observableArray([]),a.currentRegionList=ko.observable([]),a.africa=ko.observableArray([]),a.americas=ko.observableArray([]),a.asia=ko.observableArray([]),a.europe=ko.observableArray([]),a.oceania=ko.observableArray([]),a.filteredList=ko.observableArray([]),a.searchValue=ko.observable(),a.coffeeShopList=ko.observableArray([]),a.markerList=ko.observableArray([]),a.latLngList=ko.observableArray([]),a.idList=ko.observableArray([]),a.foursquareError=ko.observable(),a.noCoffee=ko.observable(!1),a.currentVenue=ko.observable(),a.starClick=ko.observable(!1),a.favoritesList=ko.observableArray([]),a.faveBtnClick=ko.observable(!1),a.noFavorites=ko.observable(!1),a.favoritesLength=ko.observable(),a.faveBtnText=ko.observable();var b="5PLNSFDCFOXXWLZOHDRG33R3PLP5OULVV0NQDPLZMOCON3OL",c="DFRQK4JG21B1ECQ104LLNMH1O5TUQ4OZC2C24AAKZCTEPJAG",d="20151221";null!==localStorage.getItem("favoriteKey")&&a.favoritesList(JSON.parse(localStorage.getItem("favoriteKey"))),a.favorites=ko.computed(function(){a.starClick()&&($("#favorite").toggleClass("starred"),a.updateFavorites(),a.starClick(!1)),a.favoritesLength(a.favoritesList().length),a.faveBtnText("My Favorites ("+a.favoritesLength()+")"),$(".faveBtn").html(a.faveBtnText())},a),a.checkFavorites=function(){for(var b=a.currentVenue().id,c=!1,d=0;d<a.favoritesList().length;d++){var e=a.favoritesList()[d].id;if(b===e){c=!0;break}}c&&$("#favorite").toggleClass("starred")},a.updateFavorites=function(){var b=$("#favorite").hasClass("starred");if(b)a.favoritesList().push(a.currentVenue()),localStorage.setItem("favoriteKey",JSON.stringify(a.favoritesList())),a.markerIcon();else{for(var c=a.currentVenue().id,d=0;d<a.favoritesList().length;d++){var e=a.favoritesList()[d].id;if(c===e){var f=d;break}}a.favoritesList().splice(f,1),localStorage.setItem("favoriteKey",JSON.stringify(a.favoritesList())),a.markerIcon()}},a.markerIcon=function(){if(0!=a.favoritesList().length)for(var b=0;b<a.markerList().length;b++)for(var c=a.markerList()[b].markerId,d=0;d<a.favoritesList().length;d++){var e=a.favoritesList()[d].name+", "+a.favoritesList()[d].id;if(c===e){a.markerList()[b].setIcon("images/faveCoffee.png");break}a.markerList()[b].setIcon("images/coffee.png")}else for(var b=0;b<a.markerList().length;b++)a.markerList()[b].setIcon("images/coffee.png")},a.listFavorites=function(){a.favoritesList().length>0?(a.faveBtnClick(!0),a.getCoffee()):a.noFavorites(!0)},a.setRegion=function(b){$(".apiError").html(""),$(".favoritesMsg").html(""),$(".noCoffeeMsg").html(""),a.searchValue(""),a.coffeeShopList([]),a.getMarkers(),a.noCoffee(!1),a.foursquareError(!1),"Africa"==b?a.currentRegionList(a.africa()):"Americas"==b?a.currentRegionList(a.americas()):"Asia"==b?a.currentRegionList(a.asia()):"Europe"==b?a.currentRegionList(a.europe()):"Oceania"==b&&a.currentRegionList(a.oceania())},a.filter=ko.computed(function(){if(a.noFavorites()){var b="To add favorites, click on coffee shop name in the list or marker then click on the star next to the coffee shop name. Please click on the above back button to return to the capitals list.";a.filteredList([]),a.coffeeShopList([]),a.searchValue(""),a.getMarkers(),$(".favoritesMsg").html(""),$(".apiError").html(""),$(".noCoffeeMsg").html(""),$(".favoritesMsg").append(b),a.noFavorites(!1)}else if(a.foursquareError())a.filteredList([]);else if(a.noCoffee()){var c="No coffee shops found in this capital, please press the back button and choose a different location.";a.filteredList([]),$(".noCoffeeMsg").append(c)}else 0==a.coffeeShopList().length||0!=a.noFavorites()||""!=a.searchValue()&&void 0!=a.searchValue()?0!=a.coffeeShopList().length||""!=a.searchValue()&&void 0!=a.searchValue()?(a.filteredList([]),0!=a.coffeeShopList().length?(a.filterCurrentList(a.coffeeShopList()),a.getMarkers()):0==a.currentRegionList().length?a.filterCurrentList(a.allPlaceList()):a.filterCurrentList(a.currentRegionList())):0==a.currentRegionList().length?a.filteredList(a.allPlaceList()):a.filteredList(a.currentRegionList()):(a.filteredList(a.coffeeShopList()),a.getMarkers());a.idList(a.filteredList())},a),a.filterCurrentList=function(b){for(var c=0;c<b.length;c++){var d=b[c].name().toLowerCase();d.includes(a.searchValue().toLowerCase())&&a.filteredList.push(b[c])}},a.back=function(){a.foursquareError(!1),$(".apiError").html(""),$(".favoritesMsg").html(""),$(".noCoffeeMsg").html(""),a.searchValue(""),a.noCoffee()?(a.noCoffee(!1),a.filteredList(a.currentRegionList())):0!=a.currentRegionList().length&&0!=a.coffeeShopList().length?(a.coffeeShopList([]),a.filteredList(a.currentRegionList())):(a.currentRegionList([]),a.coffeeShopList([]),a.filteredList(a.allPlaceList())),a.getMarkers(),null!=a.infowindow&&a.infowindow.close()},a.getCoffee=function(e){if(a.faveBtnClick()){a.faveBtnClick(!1);var f=$.map(a.favoritesList(),function(a){return new CoffeeShops(a)});a.coffeeShopList(f),a.filteredList(a.coffeeShopList()),a.searchValue("")}else if(0==a.coffeeShopList().length){var g=a.filteredList()[e].name(),h="https://api.foursquare.com/v2/venues/explore?near="+g+"&section=coffee&limit=25&client_id="+b+"&client_secret="+c+"&v="+d;$.getJSON(h,function(b){var c=$.map(b.response.groups[0].items,function(a){return new CoffeeShops(a)});a.coffeeShopList(c),a.filteredList(a.coffeeShopList()),a.searchValue("")}).complete(function(){0==a.coffeeShopList().length&&a.noCoffee(!0)}).fail(function(){a.foursquareError(!0);var b="Foursquare API cannot be reached. Please try again later.";$(".apiError").append(b)})}},a.getMarkers=function(){for(var b=0;b<a.markerList().length;b++)a.markerList()[b].setMap(null);if(a.markerList([]),0!=a.coffeeShopList().length)for(var b=0;b<a.filteredList().length;b++){var c=a.filteredList()[b].name(),d=a.filteredList()[b].venueId(),e={lat:a.filteredList()[b].latitude(),lng:a.filteredList()[b].longitude()};a.markerList().push(new google.maps.Marker({title:c,position:e,animation:null,markerId:c+", "+d}))}a.markerIcon(),a.placeMarkers()},a.placeMarkers=function(){if(0==a.coffeeShopList().length)map.setCenter(DEFAULT_CENTER),map.setZoom(DEFAULT_ZOOM);else{for(var b=0;b<a.markerList().length;b++)a.markerList()[b].setMap(map),a.markerList()[b].addListener("click",function(b){return function(){a.toggleBounce(b),a.toggleWindow(b)}}(b));0!=a.markerList().length&&a.setBounds()}},a.setBounds=function(){a.latLngList([]),a.bounds=new google.maps.LatLngBounds;for(var b=0;b<a.markerList().length;b++){var c={lat:a.markerList()[b].position.lat(),lng:a.markerList()[b].position.lng()};a.latLngList().push(new google.maps.LatLng(c))}for(var b=0;b<a.latLngList().length;b++)a.bounds.extend(a.latLngList()[b]);map.fitBounds(a.bounds)},a.toggleBounce=function(b){for(var c=0;c<a.markerList().length;c++){var d=a.markerList()[c];c==b&&null==d.getAnimation()?d.setAnimation(google.maps.Animation.BOUNCE):d.setAnimation(null)}},a.toggleWindow=function(e){var f,g=a.idList()[e].venueId(),h="/venues/"+g,i="/venues/"+g+"/hours",j="https://api.foursquare.com/v2/multi?requests="+h+","+i+"&client_id="+b+"&client_secret="+c+"&v="+d;$.ajax({url:j,dataType:"json",success:function(b){a.currentVenue(b.response.responses[0].response.venue),f=!1,a.getIwContent(f,e);var c,d,g,h,i,j=a.currentVenue().name,k=a.currentVenue().rating,l=b.response.responses[1].response.hours,m=a.currentVenue().tips.groups[0].count,n=a.currentVenue().canonicalUrl;if(a.currentVenue().hasOwnProperty("url")){var o=a.currentVenue().url;$("#iw-title").prepend('<a href="'+o+'" target="_blank">'+j+"</a>")}else $("#iw-title").prepend(j);if(void 0!=k?$("#iw-rating").append(k+"/10"):$("#iw-rating").append("No rating to show."),a.currentVenue().hasOwnProperty("bestPhoto")&&(c=a.currentVenue().bestPhoto.prefix+"original"+a.currentVenue().bestPhoto.suffix),void 0!=c?$("#iw-photo").append('<img src="'+c+'"style="width:100%; height: auto, display: block">'):($("#iw-photo").remove(),$("#hasPhoto").toggleClass("col-md-5 col-md-12")),a.currentVenue().hasOwnProperty("hours")?(1==a.currentVenue().hours.isOpen?$("#iw-isOpen").prepend("<p>Open Now</p>").css({color:"green"}):$("#iw-isOpen").prepend("<p>Closed Now</p>").css({color:"red"}),a.currentVenue().hours.hasOwnProperty("status")?$("#iw-status").append("<p>"+a.currentVenue().hours.status+"</p>"):$("#iw-status").remove()):$("#iw-isOpen").remove(),l.hasOwnProperty("timeframes"))for(var p=l.timeframes,q=0;q<p.length;q++)for(var r=p[q].days,s=p[q].open[0],t=0;t<r.length;t++){var u=a.getDay(r[t]),v=a.getTime(s.start),w=a.getTime(s.end);a.appendHours(u,v,w)}else $("#iw-hours ul").remove(),$("#iw-hours").append("<p>No information available</p>");if(a.currentVenue().hasOwnProperty("description")?(d=a.currentVenue().description,$("#iw-description").append("<p>About</p>"),$("#iw-description").append("<p>"+d+"</p>")):$("#iw-description").remove(),0==m?$("#iw-tips").remove():(g=a.currentVenue().tips.groups[0].items,a.getTips(g),$("#iw-tips").prepend('<p class="hasTips">What others have to say</p>')),a.currentVenue().contact.hasOwnProperty("formattedPhone")?(h=a.currentVenue().contact.formattedPhone,$("#iw-phoneIcon").append('<i class="fa fa-phone-square"></i>'),$("#iw-phoneNum").append("<p>"+h+"</p>")):($("#iw-phoneIcon").remove(),$("#iw-phoneNum").remove()),$("#iw-social").append('<a href="'+n+'" target="_blank"><i class="fa fa-foursquare"></i></a>'),a.currentVenue().contact.hasOwnProperty("facebook")){var x=a.currentVenue().contact.facebook;$("#iw-social").append('<a href="https://www.facebook.com/'+x+'" target="_blank"><i class="fa fa-facebook-official"></i></a>')}if(a.currentVenue().contact.hasOwnProperty("twitter")){var y=a.currentVenue().contact.twitter;$("#iw-social").append('<a href="https://www.twitter.com/'+y+'" target="_blank"><i class="fa fa-twitter"></i></a>')}if(a.currentVenue().location.hasOwnProperty("formattedAddress"))for(var q=0;q<a.currentVenue().location.formattedAddress.length;q++)i=a.currentVenue().location.formattedAddress[q],$("#iw-formattedAddress").append("<p>"+i+"</p>");a.checkFavorites()}}).fail(function(){f=!0,a.getIwContent(f,e,venue)}),0!=a.coffeeShopList().length&&map.addListener("click",function(){a.infowindow.close(),a.markerList()[e].setAnimation(null)}),a.markerAnimation=a.markerList()[e].getAnimation(),null!=a.infowindow&&a.infowindow.close(),a.infowindow=new google.maps.InfoWindow({pixelOffset:new google.maps.Size(0,-10),content:'<div class="container iw-container"><div class="row"><div class="col-md-12 loading"><i class="fa fa-spinner fa-spin"></i></div></div></div>'}),a.infowindow.addListener("domready",function(){$(".gm-style-iw").next("div").hide();var a=$(".gm-style-iw"),b=a.prev();b.children(":nth-child(2)").css({display:"none"}),b.children(":nth-child(4)").css({display:"none"}),b.children(":nth-child(3)").find("div").children().css({border:"2px solid orange"})}),null!=a.infowindow&&a.infowindow.open(map,a.markerList()[e]),a.getIwContent=function(b,c,d){var e;if(0==b)e='<div class="container iw-container"><div class="row"><div class="col-md-12" id="iw-title"><i id="favorite" class="fa fa-star"></i></div></div><div class="row"><div class="col-md-2" id="iw-rating"></div></div><div class="row"><div class="col-md-7" id="iw-photo"></div><div class="col-md-5" id="hasPhoto"><div class="row"><div class="col-md-12" id="iw-isOpen"></div></div><div class="row"><div class="col-md-12" id="iw-status"></div></div><div class="row"><div class="col-md-12" id="iw-hoursOO"><p>Hours of Operation</p></div></div><div class="row"><div class="col-md-12" id="iw-hours"><ul><li id="mon"><span>Monday</span><div>CLOSED</div></li><li id="tue"><span>Tuesday</span><div>CLOSED</div></li><li id="wed"><span>Wednesday</span><div>CLOSED</div></li><li id="thu"><span>Thursday</span><div>CLOSED</div></li><li id="fri"><span>Friday</span><div>CLOSED</div></li><li id="sat"><span>Saturday</span><div>CLOSED</div></li><li id="sun"><span>Sunday</span><div>CLOSED</div></li></ul></div></div></div></div><div class="row"><div class="col-md-12" id="iw-description"></div></div><div class="row"><div class="col-md-12" id="iw-tips"></div></div><div class="row"><div class="col-md-12"><div class="row"><div class="col-md-6" id="iw-contact"><p>Contact</p><div class="row"><div class="col-md-4" id="iw-phoneIcon"></div><div class="col-md-8" id="iw-phoneNum"></div></div><div class="row"><div class="col-md-12" id="iw-social"></div></div></div><div class="col-md-6" id="iw-location"><p>Location</p><div class="row"><div class="col-md-12" id="iw-formattedAddress"></div></div></div></div></div></div></div>',a.infowindow.open(map,a.markerList()[c]),null==a.markerAnimation&&a.infowindow.close();else{var f=a.filteredList()[c].name();e='<div class="container iw-container"><div class="row"><div class="col-md-12" id="iw-title"><p>'+f+'</p></div></div><div class="row"><div class="col-md-12"><p class="apiError">Foursquare API cannot be reached. Please try again later.</p></div></div></div>',a.infowindow.open(map,a.markerList()[c])}a.infowindow.setContent(e),$("#favorite").click(function(){a.starClick(!0)})},a.getDay=function(a){return 1==a?"Monday":2==a?"Tuesday":3==a?"Wednesday":4==a?"Thursday":5==a?"Friday":6==a?"Saturday":7==a?"Sunday":void 0},a.getTime=function(a){var b=a.slice(0,1);if("+"==b&&(a=a.slice(1)),1200==a)return"Noon";if(0==a)return"Midnight";if(a>=1300){var c=a.slice(0,2)-12,d=a.slice(2),e=c+":"+d+" PM";return e}if(1e3>a){var c=a.slice(1,2),d=a.slice(2),e=c+":"+d+" AM";return e}var c=a.slice(0,2),d=a.slice(2),e=c+":"+d+" AM";return e},a.appendHours=function(a,b,c){"Monday"==a?$("#mon").replaceWith("<li><span>"+a+"</span><div>"+b+" - "+c+"</div></li>"):"Tuesday"==a?$("#tue").replaceWith("<li><span>"+a+"</span><div>"+b+" - "+c+"</div></li>"):"Wednesday"==a?$("#wed").replaceWith("<li><span>"+a+"</span><div>"+b+" - "+c+"</div></li>"):"Thursday"==a?$("#thu").replaceWith("<li><span>"+a+"</span><div>"+b+" - "+c+"</div></li>"):"Friday"==a?$("#fri").replaceWith("<li><span>"+a+"</span><div>"+b+" - "+c+"</div></li>"):"Saturday"==a?$("#sat").replaceWith("<li><span>"+a+"</span><div>"+b+" - "+c+"</div></li>"):"Sunday"==a&&$("#sun").replaceWith("<li><span>"+a+"</span><div>"+b+" - "+c+"</div></li>")},a.getTips=function(b){var c,d,e,f,g;g=b.length>5?5:b.length;for(var h=0;g>h;h++)c=b[h].text,b[h].hasOwnProperty("user")?(d=b[h].user.hasOwnProperty("firstName")?b[h].user.firstName:"",e=b[h].user.hasOwnProperty("lastName")?b[h].user.lastName:""):(d="",e=""),f=""!=d&&""!=e?d+" "+e:""!=d&&""==e?d:""==d&&""!=e?e:"Unknown",a.appendTips(c,f,g,h)},a.appendTips=function(a,b,c,d){var e="<blockquote><p>"+a+"</p><footer>"+b+"</footer></blockquote>";c-1!=d?$("#iw-tips").append(e+"<hr>"):$("#iw-tips").append(e)}},a.onListClick=function(b){0==a.markerList()?a.getCoffee(b):(a.toggleBounce(b),a.toggleWindow(b))};var e="https://restcountries.eu/rest/v1/all";$.getJSON(e,function(b){var c=$.map(b,function(a){return""!=a.capital&&""!=a.region?new Place(a):void 0});a.allPlaceList(c)}).complete(function(){for(var b=0;b<a.allPlaceList().length;b++){var c=a.allPlaceList()[b];"Africa"==c.region()?a.africa().push(c):"Americas"==c.region()?a.americas().push(c):"Asia"==c.region()?a.asia().push(c):"Europe"==c.region()?a.europe().push(c):"Oceania"==c.region()&&a.oceania().push(c)}}).fail(function(){var a="REST Countries API cannot be reached. Please try again later.";$(".apiError").append(a)})};ko.applyBindings(new ViewModel);